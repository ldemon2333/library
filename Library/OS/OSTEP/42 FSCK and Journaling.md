正如我们目前所见，文件系统管理一组数据结构以实现预期的抽象：文件、目录以及支持我们期望从文件系统获得的基本抽象所需的所有其他元数据。与大多数数据结构（例如，在正在运行的程序的内存中找到的数据结构）不同，文件系统数据结构必须持久，即它们必须长期存在，存储在即使断电也能保留数据的设备上（例如硬盘或基于闪存的 SSD）。

文件系统面临的一个主要挑战是如何在断电或系统崩溃的情况下更新持久数据结构。
具体来说，如果在更新磁盘结构的过程中，有人被电源线绊倒并且机器断电，会发生什么？或者操作系统遇到错误并崩溃？由于断电和崩溃，更新持久数据结构可能非常棘手，并导致文件系统实现中一个新的有趣问题，称为崩溃一致性问题。

这个问题很容易理解。想象一下，为了完成一个特定的操作，你必须更新两个磁盘结构 A 和 B。由于磁盘一次只处理一个请求，因此其中一个请求将首先到达磁盘（A 或 B）。如果系统在一次写入完成后崩溃或断电，磁盘结构将处于不一致的状态。因此，我们有一个所有文件系统都需要解决的问题：

## 关键：如何在崩溃的情况下更新磁盘
系统可能会在两次写入之间崩溃或断电，因此磁盘上的状态可能只会部分更新。崩溃后，系统启动并希望再次安装文件系统（以便访问文件等）。鉴于崩溃可能发生在任意时间点，我们如何确保文件系统将磁盘上的映像保持在合理的状态？

在本章中，我们将更详细地描述这个问题，并介绍文件系统用来克服这个问题的一些方法。我们首先研究旧文件系统采用的方法，即 fsck 或文件系统检查器。然后，我们将注意力转向另一种方法，即日志记录（也称为预写日志记录），这种方法会给每次写入增加一点开销，但可以更快地从崩溃或断电中恢复。我们将讨论日志记录的基本机制，包括 Linux ext3（一种相对现代的日志文件系统）实现的几种不同类型的日志记录。

# 42.5 Summary
我们介绍了崩溃一致性问题，并讨论了解决该问题的各种方法。构建文件系统检查器的旧方法有效，但在现代系统上恢复速度可能太慢。因此，许多文件系统现在使用日志记录。日志记录将恢复时间从 O（磁盘卷大小）缩短到 O（日志大小），从而大大加快了崩溃和重启后的恢复速度。出于这个原因，许多现代文件系统都使用日志记录。我们还看到，日志记录可以有多种不同的形式；最常用的是有序元数据日志记录，它减少了日志的流量，同时仍然为文件系统元数据和用户数据保留了合理的一致性保证。最后，对用户数据的强有力保证可能是最重要的事情之一；奇怪的是，正如最近的研究表明，这一领域仍在进行中。

