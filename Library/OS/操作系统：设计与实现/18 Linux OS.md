Linux 的两面
- 加载第一个进程
	- 相当于在OS中“放置一个位于初始状态的状态机”
	- “Initramfs”模式
- 包含一些进程可操纵的OS对象
- 除此之外“什么也没有”（Kernel 就是一个trap handler）

# 18.2 启动 Linux
init 被加载的时候，OS有哪些初始对象

在操作系统启动时，`init` 进程是第一个被加载并执行的用户级进程。操作系统在加载 `init` 时，会创建和初始化一系列关键的内核对象和系统资源，这些对象和资源为操作系统的进一步运行提供支持。以下是操作系统加载 `init` 时的一些初始对象：

### 1. **进程管理相关对象**
   - **进程表（Process Table）**：操作系统会初始化进程表来管理所有正在运行的进程。`init` 进程是系统启动后第一个进程，它的创建标志着操作系统从内核态进入用户态。
   - **调度器（Scheduler）**：初始化进程调度器来决定哪个进程可以占用 CPU 资源。调度器将负责调度包括 `init` 在内的所有进程。
   - **进程控制块（PCB）**：每个进程都会有一个进程控制块，内核会创建并初始化进程控制块，用于管理进程的状态、调度信息、内存等。

### 2. **内存管理相关对象**
   - **页表（Page Table）**：系统会初始化虚拟内存管理相关的数据结构，如页表，用于虚拟地址到物理地址的映射。
   - **内存池和堆栈（Memory Pools and Stack）**：操作系统会分配内存池，用于存放进程堆栈、堆空间等。每个进程都会有一个独立的堆栈，用于存储函数调用信息。

### 3. **文件系统相关对象**
   - **虚拟文件系统（VFS）**：`init` 进程加载时，操作系统会初始化虚拟文件系统，以便支持各种不同类型的文件系统，如 ext4、xfs 等。
   - **根文件系统（Root Filesystem）**：操作系统会挂载根文件系统，使得文件系统的树形结构能够被访问。根文件系统通常包含系统的配置文件、库文件、程序文件等。
   - **设备文件（Device Files）**：操作系统会在 `/dev/` 目录下创建设备文件，允许进程通过文件接口访问硬件设备。

### 4. **硬件和设备管理对象**
   - **设备驱动程序（Device Drivers）**：操作系统会加载和初始化设备驱动程序来管理硬件设备，如硬盘、网卡、显示器等。设备驱动程序会被注册到内核中，以便操作系统能通过标准接口（如 `/dev/`）访问硬件设备。
   - **中断向量（Interrupt Vector）**：初始化时，操作系统会设置中断向量表，用于处理来自硬件设备的中断请求。中断处理程序会在必要时被调用。

### 5. **系统调用接口**
   - **系统调用（System Call Interface）**：`init` 进程启动时，操作系统会确保系统调用接口正常工作。系统调用是用户空间程序与内核之间的接口，允许用户进程访问内核功能。
   
### 6. **用户空间和服务管理对象**
   - **`init` 进程**：`init` 是系统启动后第一个用户进程，它会执行系统初始化操作，包括启动系统服务、守护进程等。
   - **守护进程（Daemon Processes）**：`init` 进程会根据系统配置（如 `/etc/inittab` 或 `/etc/systemd/system`）启动其他守护进程，这些守护进程通常是系统后台运行的进程，用于提供各种服务（如网络、日志、定时任务等）。

### 7. **时间和时钟管理对象**
   - **时钟中断（Clock Interrupts）**：操作系统会初始化硬件时钟和软件时钟，以确保操作系统能够准确管理时间。
   - **时间管理结构**：操作系统会创建和初始化相关的数据结构，用于记录当前时间、设置定时器和处理定时任务。

### 8. **安全与权限管理对象**
   - **用户权限管理（User and Group Management）**：操作系统会初始化用户、组和权限管理系统，以确保用户进程的安全性和隔离性。
   - **安全模块（Security Modules）**：例如 SELinux、AppArmor 等安全模块可能会在 `init` 启动过程中加载，用于加强系统的安全性和访问控制。

### 9. **进程间通信（IPC）机制**
   - **信号量、消息队列、共享内存等**：操作系统会初始化进程间通信机制，以支持不同进程之间的数据交换和同步。
   - **管道和套接字**：管道、FIFO 和套接字等 IPC 机制可能会被初始化并作为进程之间通信的一种方式。

### 10. **日志和监控系统**
   - **日志守护进程（Syslog Daemon）**：`init` 进程会启动日志守护进程（如 `syslog`），用于记录操作系统和应用程序的事件和错误信息。
   - **监控和审计**：操作系统可能会初始化监控和审计工具，用于跟踪系统的性能、错误和安全事件。

### 11. **网络栈**
   - **网络协议栈（Network Stack）**：操作系统会初始化网络协议栈，支持 TCP/IP 等协议的运行，提供网络服务和通信能力。
   - **网络接口和配置**：`init` 进程会启动网络相关的服务，配置网络接口并确保网络连接正常。

### 总结：
`init` 进程启动时，操作系统会初始化多个关键的内核对象和系统资源，如进程表、内存管理、文件系统、设备驱动程序、安全机制等，这些初始化步骤为操作系统的进一步运行和用户进程的启动提供了基础。

---

init ram fs
就是Linux Kernel 启动后的“第一个世界”
- 把控制权交给一个拥有高权限的用户程序

`initramfs`（初始 RAM 文件系统）是一个临时的根文件系统，用于在 Linux 启动时加载操作系统。它的主要作用包括：

1. **早期初始化**: 在内核启动后，`initramfs` 提供必要的驱动程序和工具，以便识别和挂载实际的根文件系统。

2. **设备驱动**: 包含必要的驱动程序，使系统能够访问硬件设备，比如磁盘和网络接口。

3. **文件系统支持**: 支持各种文件系统的驱动，使得可以挂载不同类型的根文件系统。

4. **执行初始化脚本**: 包含启动脚本，可以在根文件系统挂载之前执行必要的初始化任务。

5. **提供故障恢复**: 如果根文件系统无法挂载，`initramfs` 可以提供救援环境来解决问题。

通过使用 `initramfs`，Linux 能够更灵活地处理复杂的启动过程，特别是在使用 LVM、RAID 或网络启动等场景中。

![[Pasted image 20241113235725.png]]

# 18.3 构建应用程序的世界
![[Pasted image 20241113235755.png]]


mount，switch_root,
什么是挂载，pivot_root

switch_root 之后就有df / 文件系统了，init_ram fs 小世界到了实际linux世界，到根文件系统找/sbin/init，执行systemd

![[Pasted image 20241114001239.png]]


是的，`systemd` 通常是 Linux 系统中的第一个进程，即 PID 1。作为第一个启动的进程，`systemd` 负责初始化系统并管理其他所有进程。以下是一些关于 `systemd` 作为一号进程的关键信息：

### 作为 PID 1 的功能

1. **系统初始化**:
   - 在内核启动后，`systemd` 会被加载并初始化系统环境，设置必要的系统资源和服务。

2. **服务管理**:
   - 作为进程管理器，`systemd` 负责启动和管理系统中的其他服务和守护进程。

3. **进程监控**:
   - `systemd` 监控其管理的进程，并在进程崩溃时可以重启它们，确保系统的稳定性。

4. **资源控制**:
   - 使用控制组（cgroups）来管理和限制服务的资源使用。

5. **日志管理**:
   - 集成了 `journald`，提供集中式的日志记录。

### 启动过程

当系统启动时，内核会首先启动 `systemd`，然后 `systemd` 会根据配置文件启动其他服务和进程，形成系统的整体运行环境。

# Take-away Messages

我们从 CPU Reset 后的 “硬件初始状态” 到操作系统加载完 init 进程后的 “软件初始状态”，从此以后，计算机系统中的一切都是由应用程序主导的，操作系统只是提供系统调用这一服务接口。正是系统调用 (包括操作系统中的对象) 这个稳定的、向后兼容的接口随着历史演化和积累，形成了难以逾越的技术屏障，在颠覆性的技术革新到来之前，另起炉灶都是非常困难的。





