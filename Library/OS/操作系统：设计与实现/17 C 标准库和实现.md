应用程序
sh，gcc
libc
OS = 对象 + API（Syscall）
硬件

系统调用是地基，C语言是框架，系统调用是对硬件的浅层封装

libc 语言机制上的运行库
- 大部分可以用 C 语言本身实现
- 少部分需要一些底层支持，内联汇编

![[Pasted image 20241108121821.png]]



![[Pasted image 20241107233218.png]]

这段脚本是一个用于 `musl-gcc` 的封装脚本，主要目的是将编译器调用定向到使用 `musl` 标准库的编译环境。以下是逐步解释：

### 1. **`#!/bin/sh`**
   - 指定使用 `/bin/sh` 来解释这个脚本。这是标准的 shebang 行，用来指明脚本的解释器。

### 2. **`exec "${REALGCC:-cc}" "$@" -specs "/usr/lib/x86_64-linux-musl/musl-gcc.specs"`**
   - 这行使用 `exec` 来执行另一个命令，而不再返回到当前 shell，这样可以用新的命令直接替代当前的 shell 进程。

#### 详细分析：

- **`${REALGCC:-cc}`**：
   - 这个语法 `${VAR:-DEFAULT}` 表示如果环境变量 `REALGCC` 已定义且非空，则使用其值；否则，使用默认值 `cc`。
   - `REALGCC` 是一个可选的环境变量，用来指定实际的 GCC 编译器。如果未设置 `REALGCC`，则会使用默认的 `cc`（通常是系统默认的 C 编译器）。

- **`"$@"`**：
   - `$@` 是一个 shell 特殊变量，表示传递给脚本的所有参数。加上双引号 `"$@"` 能确保每个参数被正确引用。
   - 这意味着，脚本将接收的所有参数原封不动地传递给 GCC 编译器。

- **`-specs "/usr/lib/x86_64-linux-musl/musl-gcc.specs"`**：
   - `-specs` 选项用于告诉 GCC 使用特定的规格文件（`.specs` 文件）来自定义编译行为。
   - `"/usr/lib/x86_64-linux-musl/musl-gcc.specs"` 是一个 GCC 规格文件，通常用来指定与 `musl` 相关的编译和链接选项，使得编译的程序使用 `musl libc` 而不是系统默认的 `glibc`。
   - 这个 `.specs` 文件包含了 `musl-gcc` 需要的编译设置，比如将库路径指向 `musl` 的位置，以及设置适当的链接选项等。

### 总结

这个脚本的作用是调用一个实际的 GCC 编译器（可以通过 `REALGCC` 指定），并将 `-specs` 选项设置为 `musl-gcc.specs` 文件。这样可以确保所有编译和链接操作都使用 `musl` 标准库，而非系统默认的 C 标准库。


---

`mov %rsp, %rdi` 是一条汇编指令，通常在 x86-64 架构的汇编代码中出现。它的作用是将栈指针寄存器 `%rsp` 的值复制到寄存器 `%rdi` 中。具体来说，这条指令是将栈指针的当前值存储到 `rdi` 寄存器。

### 解释

1. **`%rsp`**: 这是 x86-64 架构中的栈指针寄存器（Stack Pointer Register）。它指向当前栈帧的顶部，也就是说，它保存了栈中当前可用内存的地址。当调用函数时，栈指针会发生变化，因为新的栈帧会被推到栈中。

2. **`%rdi`**: 这是 x86-64 架构中的第一个函数参数寄存器。在调用约定中，传递给函数的第一个参数通常存放在 `rdi` 寄存器中（对于 64 位函数调用约定如 System V ABI）。

### 指令解析

```asm
mov %rsp, %rdi
```

- `mov` 指令用于将一个操作数的值移动到另一个操作数中。它不会进行任何算术操作，而是简单地将数据复制。
- `%rsp` 是源操作数（从栈指针寄存器中获取值）。
- `%rdi` 是目标操作数（将值复制到 `rdi` 寄存器）。

这条指令的含义是：将栈指针 `%rsp` 的当前值复制到 `rdi` 寄存器中。可能的用途包括：

- 作为函数调用的一部分，其中栈指针被复制到 `rdi` 寄存器，可能是为了将栈帧地址或某些指针作为参数传递给函数。
- 在调用其他函数时，可能需要将栈指针传递给另一个函数，或者处理函数的栈帧。

### 示例场景

1. **函数调用传递栈指针**：
   假设在某些情况下，您需要将当前栈指针作为参数传递给另一个函数（可能用于栈帧操作），`mov %rsp, %rdi` 会将当前栈指针值存储在 `%rdi` 中，然后可以将其传递给其他函数。

2. **计算栈空间**：
   在某些程序中，栈指针 `%rsp` 可能会用来计算栈空间的位置或其他类似的指针操作。将其复制到 `%rdi` 寄存器可能是为了后续处理。

### 总结
`mov %rsp, %rdi` 是一条将栈指针的值存储到 `rdi` 寄存器的汇编指令。在 x86-64 汇编中，`%rsp` 代表栈指针，`%rdi` 是第一个参数寄存器。


---

在 `gdb` 调试中，`p/s argv` 是一个常见的命令格式，用于打印（`p`）或显示（`s`）程序的命令行参数 `argv`。通常，`argv` 是一个指向字符串的指针数组，每个字符串是通过命令行传递给程序的参数。

### `argv` 的作用

在 C 语言中，`argv` 是 `main` 函数的一个参数，它是一个字符串数组，包含了从命令行传递给程序的所有参数。它的结构通常是这样的：

```c
int main(int argc, char *argv[]) {
    // argc 是命令行参数的个数
    // argv 是一个字符串数组，每个元素是一个命令行参数
}
```

例如，对于以下命令行：
```bash
./my_program arg1 arg2 arg3
```

`argv` 会像这样：
- `argv[0]` = `"./my_program"`（程序本身的路径）
- `argv[1]` = `"arg1"`
- `argv[2]` = `"arg2"`
- `argv[3]` = `"arg3"`
- `argv[argc]` = `NULL`（`argv` 数组的最后一个元素是 `NULL`，表示参数的结束）

### `p/s argv` 在 `gdb` 中的意义

1. **`p argv`**:
   - 这条命令会打印出 `argv` 指针本身的值。`argv` 是一个指向字符串数组的指针，因此执行 `p argv` 会输出这个指针的值（即 `argv` 数组的内存地址）。

   ```bash
   (gdb) p argv
   $1 = (char **) 0x7fffffffe350
   ```

   这表示 `argv` 是一个指向某个地址（例如 `0x7fffffffe350`）的指针，指向一个字符串数组。

2. **`p *argv`**:
   - 这条命令会打印 `argv` 数组中的第一个元素，即程序的第一个命令行参数。因为 `argv` 是一个指针数组，所以 `*argv` 代表 `argv[0]`，即程序的名称。

   ```bash
   (gdb) p *argv
   $2 = 0x555555556010 "./my_program"
   ```

3. **`p argv[i]`**:
   - 如果您想查看 `argv` 中某个特定索引的值（即命令行的某个参数），可以使用这种格式。例如，查看 `argv[1]`（第一个参数）：
   
   ```bash
   (gdb) p argv[1]
   $3 = 0x555555556020 "arg1"
   ```

4. **`s argv`**:
   - `s` 是 `gdb` 中的一个命令，用来显示值（字符串）的内容。如果您用 `s` 来显示 `argv`，它将显示 `argv` 指向的字符串数组的内容，直到遇到 `NULL`。
   
   ```bash
   (gdb) s argv
   ```

   **注意**：`s` 通常用于显示字符串，因此在显示 `argv` 时，最好使用 `p` 来打印指针，或者通过 `*argv` 来查看数组的内容。

### 例子

假设我们有以下代码：

```c
#include <stdio.h>

int main(int argc, char *argv[]) {
    for (int i = 0; i < argc; i++) {
        printf("argv[%d]: %s\n", i, argv[i]);
    }
    return 0;
}
```

如果我们在 `gdb` 中调试并想查看 `argv` 数组的内容，可以：

```bash
(gdb) p argv
$1 = (char **) 0x7fffffffe350
(gdb) p *argv
$2 = 0x555555556010 "./my_program"
(gdb) p argv[1]
$3 = 0x555555556020 "arg1"
```

### 总结
- `p argv` 打印 `argv` 的地址。
- `p *argv` 打印 `argv[0]`，即程序的名称。
- `p argv[i]` 打印命令行参数中的第 `i` 个参数。
- `s argv` 通常用于显示字符串，但在 `gdb` 中直接用 `s` 查看 `argv` 并不常见，通常使用 `p` 来打印数组内容。