我们可以把设备想象成一组寄存器，以及寄存器基础上的一个设备通信协议，能够实现处理器和设备之间的数据交换：数据可以小到一个字符 (串口)，也可以大到程序和海量的数据 (GPU)。

# 27.1 文件和文件描述符
![[Pasted image 20241202122154.png]]

![[Pasted image 20241202122206.png]]
父子进程共用 offset
![[Pasted image 20241202122227.png]]

`fork()` 对所有文件描述符完成一个浅拷贝，且`fork()`实现带来了系统的复杂性。

如果我们为 mmap 映射超过文件大小的内存，会发生什么？随着操作系统中机制的增加：mmap, fork, ...，它们之间的交互会产生意想不到的 “意外”，这也是给操作系统设计者带来的最大挑战。


# 27.2 实现文件
![[Pasted image 20241202122740.png]]
![[Pasted image 20241202122816.png]]


# 27.3 设备驱动程序
![[Pasted image 20241202122926.png]]

**一个设备驱动程序**：理解了设备驱动程序的职责是把系统调用 “翻译” 成与设备能听懂的数据，我们也可以实现 file_operations 中相应的操作，从而模拟一个设备。

![[Pasted image 20241202122959.png]]

![[Pasted image 20241202123045.png]]


# Take-away Messages
任何实现了 struct file_operations 的操作系统对象可以都是 “文件”：可以是 /dev/null 这样的虚拟设备，可以是 /proc/stats 中的虚拟 “文件”，可以是一个管道，也可以是文件系统中普通的字节序列。
