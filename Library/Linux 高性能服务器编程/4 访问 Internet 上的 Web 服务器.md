# 4.1 实例总图
![[Pasted image 20250206221702.png]]

# 4.2 部署代理服务器
## 4.2.1 HTTP 代理服务器的工作原理
代理服务器按照其使用方式和作用，分为正向代理服务器、反向代理服务器和透明代理服务器。

正向代理要求客户端自己设置代理服务器的地址。客户的每次请求都将直接发送到改代理服务器，并由代理服务器来请求目标资源。

反向代理设置在服务器端，将请求转发给内部网络上的服务器，并将从内部服务器上得到的结果返回给客户端。
![[Pasted image 20250206222858.png]]
透明代理只能设置在网关上。代理服务器通常还提供缓存目标资源的功能。

数据包按照其逻辑关系分为如下 4 个部分：
- 代理服务器访问 DNS 服务器以查询域名 www.baidu.com 对应的 IP 地址，包括数据包8、9
- 代理服务器查询路由器 MAC 地址的 ARP 请求和应答，包括数据包6、7
- wget 客户端和代理服务器之间的 HTTP 通信
- 代理服务器和 Web 服务器之间的 HTTP 通信

# 4.4 访问 DNS 服务器
![[Pasted image 20250206225139.png]]
squid 程序通过读取 /etc/resolv.conf 文件获得 DNS 服务器的 IP 地址，然后将控制权传递给内核中的 UDP 模块。UDP 模块将 DNS 查询报文封装成 UDP 数据报，然后 UDP 模块调用 IP 服务。


# 4.5 本地名称查询
一般来说，通过域名来访问 Internet 上的某台主机时，需要使用 DNS 服务来获取该主机的 IP 地址。但如果通过主机名来访问本地局域网上的机器，则可通过本地的静态文件来获得该机器的 IP 地址。

# 4.6 HTTP 通信
将 wget 客户端和代理服务器之间的通信过程表示为如下：
![[Pasted image 20250206230118.png]]
## 4.6.1 HTTP 请求
HTTP 请求的部分内容如下：
![[Pasted image 20250206230302.png]]
![[Pasted image 20250206230312.png]]

GET、HEAD、OPTIONS、TRACE, PUT 和 DELETE 等请求方法被认为是等幂的（idempotent），即多次连续的、重复的请求和只发送一次该请求具有完全相同的效果。

## 4.6.2 HTTP 应答
![[Pasted image 20250207091744.png]]

第一行是状态码。
![[Pasted image 20250207091812.png]]

Cookie 是服务器发送给客户端的特殊信息（通过 HTTP 应答的头部字段“Set-Cookie”），客户端每次向服务器发送给请求的时候都需要带上这些信息。

在所有头部字段之后，HTTP 应答必须包含一个空行，以标识头部字段的结束。状态行和每个头部字段都必须以<CR><LF>结束；