# 1.1 TCP/IP 协议族体系结构以及主要协议
TCP/IP 协议族是一个四层协议系统。
![[Pasted image 20250110160538.png]]
## 1.1.1 数据链路层
数据链路层实现了网卡接口的网络驱动程序。两个常用的协议是 ARP 协议（Address Resolve Protocol，地址解析协议）和RARP协议（逆地址解析协议）。它们实现了 IP 地址和机器物理地址（MAC 地址）之间的相互转换。

网络层使用 IP 地址寻址一台机器，而数据链路层使用物理地址寻址一台机器，因此网络层必须先将目标机器的 IP 地址转化成物理地址，才能使用数据链路层提供的服务，这就是ARP协议用途。

## 1.1.2 网络层
选择中间路由器，以确定两台主机之间的通信路径。

网络层最核心的协议是 IP 协议，IP 协议根据数据包的目的 IP 地址来决定如何投递它。如果数据包不能直接发送给目标主机，那么 IP 协议就为它寻找一个合适的下一条（next hop）路由器，并将数据包交付给该路由器来转发。

网络层另外一个重要的协议是 ICMP 协议。它是 IP 协议的重要补充，主要用于检测网络连接。ICMP 协议使用的报文格式如下：
![[Pasted image 20250110161316 1.png]]
8 位类型字段用于区分报文类型。它将 ICMP 报文分为两大类：一类是差错报文，这类报文主要用来回应网络错误，比如目标不可到达（类型值为3）和重定向（5）；另一类是查询报文，这类报文用来查询网络信息，比如 ping 程序就是使用 ICMP 报文查看目标是否可到达（类型值为8）。

ICMP 协议并非严格意义上的网络层协议，因为它使用处于同一层的 IP 协议提供的服务。

## 1.1.3 传输层
传输层为两台主机上的进程提供端到端的通信。不在乎数据包的中转过程。
![[Pasted image 20250110161843.png]]
传输层协议主要有三个：TCP 协议、UDP协议和SCTP协议

TCP 协议为应用层提供可靠的、面向连接的和基于流（stream）的服务。TCP 协议使用超时重传、数据确认等方式来确保数据包被正确地发送至目的端，因此 TCP 服务是可靠的。使用TCP双方必须先建立TCP连接，并在内核中为该连接维持一些必要的数据结构，连接状态、读写缓冲区、以及诸多定时器。当通信结束时，双发必须关闭连接以释放这些内核数据。TCP 服务是基于流的。基于流的数据没有边界（长度）限制。

UDP，它为应用层提供不可靠、无连接和基于数据报的服务。不可靠，UDP 只是简单地通知应用程序发送失败。因此，使用 UDP 协议的应用程序通常要自己处理数据确认、超时重传等逻辑。

## 1.1.4 应用层
应用层协议很多：
- ping 是应用程序
- telnet 协议是一种远程登录协议
- OSPF （开放最短路径优先）用于路由器之间的通信
- DNS

# 1.2 封装
![[Pasted image 20250110162815.png]]
经过 TCP 封装后的数据称为 TCP 报文段 (TCP message segment)，TCP 协议为通信双方维持一个连接，并且在内核中存储相关数据。
![[Pasted image 20250110162938.png]]
经过 UDP 封装后的数据称为 UDP 数据报（UDP datagram）。UDP 无须为应用层数据保存副本，因为它提供的服务是不可靠的。当一个 UDP 数据报被成功发送之后，UDP 内核缓冲区中的该数据报就被丢弃了。如果应用程序检测到该数据报未能被接收端正确接收，并打算重发这个数据报，则应用程序需要重新从用户空间将该数据报拷贝到 UDP 内核发送缓冲区中。

经过 IP 封装后的数据报称为 IP 数据报（IP datagram）。

经过数据链路层封装的数据称为帧（frame）。传输媒介不同，帧的类型也不同。比如，以太网上传输的是以太网帧（ethernet frame），而令牌环网络上传输的则是令牌环帧（token ring frame）。以太网帧封装格式如下。
![[Pasted image 20250110223843.png]]
帧的最大传输单元（Max Transmit Unit，MTU），即帧最多能携带多少上层协议数据（比如 IP 数据报），通常受到网络类型的限制。图 1-6 所示的以太网帧的 MTU 是1500 字节。过长的IP 数据报需要被分片（fragment）传输。

# 1.3 分用
各层协议处理数据中的头部，将处理后的帧交给目标进程。这个过程称为分用。
![[Pasted image 20250110224243.png]]

# 1.4 测试网络
![[Pasted image 20250110224748.png]]
# 1.5 ARP 协议工作原理
ARP 协议能实现任意网络层地址到任意物理地址的转换，这里仅讨论 IP 地址到 MAC 地址的转换。其工作原理是：当主机需要发送数据包到另一个主机时，它首先需要知道目标主机的MAC地址。如果主机只知道目标的IP地址，它会广播一个ARP请求包到网络上。这个请求包包含了发送者的IP地址和MAC地址，以及目标的IP地址（但没有目标的MAC地址）。在同一局域网中，所有主机都会接收到这个ARP请求。拥有该目标IP地址的主机会回应一个ARP应答包，包中包含其MAC地址。这个应答是单播发送给请求者的。

## 1.5.1 以太网 ARP 请求/应答报文详解
![[Pasted image 20250110225234.png]]
- 硬件类型字段定义物理地址的类型，它的值为 1 表示 MAC 地址。
- 协议类型字段表示要映射的协议地址类型，它的值为 0x800，表示 IP 地址。
- 操作字段指出 4 种操作类型：ARP 请求（值为1）、ARP 应答（值为2），RARP 请求（值为3）和RARP 应答（值为4）。

## 1.5.2 ARP 高速缓冲的查看和修改
通常，ARP 维护一个高速缓冲，其中包含经常访问（比如网关地址）或最近访问的机器的 IP 地址到物理地址的映射。

Linux 下使用 `arp` 命令来查看和修改 ARP 高速缓冲。比如，ernest-laptop 在某一时刻（注意，ARP 高速缓冲是动态变化的）的ARP 缓冲内容如下（使用 `arp -a`）
![[Pasted image 20250110230041.png]]

其中，第一项描述的是另一台测试机器 Kongming20（IP 地址、MAC 地址），第二项描述的是路由器。下面两条命令则分别删除和添加一个 ARP 缓冲项：
![[Pasted image 20250110230231.png]]

## 1.5.3 使用 tcpdump 观察 ARP 通信过程
我们从 ernest-laptop 上执行telnet 命令登录 kongming20 的 echo 服务，并使用 tcpdump 抓取这个过程中两台测试机器之间交换的以太网帧。具体操作如下：
![[Pasted image 20250110230608.png]]

当执行 telnet 命令并在两台通信主机之间建立 TCP 连接后，quit 退出 telnet 客户端程序（因为 ARP 通信在 TCP 连接建立之前就以及完成）。tcpdump 抓取到的众多数据包中，只有最靠前的两个和 ARP 通信有关。
![[Pasted image 20250110230838.png]]

第一个数据包中，目的端的物理地址为全 f，表示以太网的广播地址，用以表示整个 LAN。该 LAN 上的所有机器都会收到并处理这样的帧。数值 0x806 是以太网帧头部的类型字段的值，它表示分用的目标是 ARP 模块。该以太网帧的长度为 42 字节（tcpdump 位未统计 CRC 字段），数据部分长度为 28 字节。”Request“ 表示这是个 ARP 请求，”who-has“ 则表示是 ernest-laptop 要查询 Kongming20 的物理地址。

第二个数据包中，”Reply“ 表示这是一个 ARP 应答，表示目标机器 Kongming20 报告其物理地址。该以太网帧的长度为60字节（实际上是64字节），可见它使用了填充字节来满足最小帧长度。
![[Pasted image 20250110231808.png]]
- ARP 请求和应答是从以太网驱动程序发出的。
- 路由器也将接收到以太网帧 1，因为该帧是一个广播帧。

# 1.6 DNS 工作原理
域名查询服务有很多种实现方式：比如 NIS、DNS和本地静态文件等。

## 1.6.1 DNS 查询和应答报文详解
DNS 查询和应答报文的格式如下：
![[Pasted image 20250110232207.png]]
16 位标识字段用于标记一对 DNS 查询和应答，以此区分一个 DNS 应答是哪个 DNS 查询的回应。

16 位标志字段用于协商具体的通信方式和反馈通信状态。
![[Pasted image 20250110232407.png]]
![[Pasted image 20250110232420.png]]


## 1.6.2 Linux 下访问 DNS 服务
先知道 DNS 服务器的 IP 地址，Linux 使用 `/etc/resolv.conf` 文件来存放 DNS 服务器的 IP 地址。机器 ernest-laptop 上，该文件的内容如下：
![[Pasted image 20250110232659.png]]
两个 IP 地址分别是首选 DNS 服务器地址和备选 DNS 服务器地址。文件中的注释说明这两个 DNS 服务器地址是由网络管理程序写入的。

Linux 下一个常用的访问 DNS 服务器的客户端程序是 host，比如下面的命令是向首选 DNS 服务器 219.239.26.42 查询机器 www.baidu.com 的 IP 地址：
![[Pasted image 20250110232955.png]]
host 命令的输出说明，机器名 www.baidu.com 是 www.a.shifen.com 的别名，并且该机器名对应两个 IP 地址。host 命令使用 DNS 协议和 DNS 服务器通信，其 -t 选项告诉 DNS 协议使用哪种查询类型。这里使用的是 A 类型，即通过机器的域名获得其 IP 地址。

## 1.6.3 使用 tcpdump 观察 DNS 通信过程
![[Pasted image 20250110233312.png]]
这一次执行 tcpdump 抓包时，使用 `port domain` 来过滤数据包，表示只抓取使用 domain （域名）服务的数据包，即 DNS 查询和应答报文。
![[Pasted image 20250110233424.png]]

数据包开始的 ”IP“ 指出，它们后面的内容是 IP 数据报。tcpdump 以 ”IP 地址 . 端口号“ 的形式来描述通信的某一端；以 ">" 表示数据传输的方向。53 是 DNS 服务使用的端口。

# 1.7 socket 和 TCP/IP 协议族的关系
数据链路层、网络层、传输层协议是在内核中是实现的。OS 实现一组系统调用，使得应用程序能够访问这些协议提供的服务。实现这组系统调用的 API 主要有两套：socket 和 XTI。

由 socket 定义的这一组 API 提供：
- 将应用程序数据从用户缓冲区中复制到 TCP/UDP 内核发送缓冲区，以交付内核来发送数据（send 函数），或者复制回用户缓冲区。
- 应用程序可以通过它们来修改内核中各层协议的某些头部信息或其他数据结构，从而精细控制底层通信的行为。

socket 是一套通用网络编程接口，可以访问其他网络协议栈。