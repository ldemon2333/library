# Bridge 模式
当`Docker`进程启动时，会在主机上创建一个名为`docker0`的虚拟网桥，此主机上启动的`Docker`容器会连接到这个虚拟网桥上。虚拟网桥的工作方式和物理交换机类似，这样主机上的所有容器就通过交换机连在了一个二层网络中。从`docker0`子网中分配一个 IP 给容器使用，并设置 docker0 的 IP 地址为容器的**默认网关**。在主机上创建一对虚拟网卡`veth pair`设备，Docker 将 veth pair 设备的一端放在新创建的容器中，并命名为`eth0`（容器的网卡），另一端放在主机中，以`vethxxx`这样类似的名字命名，并将这个网络设备加入到 docker0 网桥中。可以通过`brctl show`命令查看。

`bridge`模式是 docker 的默认网络模式，不写`–net`参数，就是`bridge`模式。使用`docker run -p`时，docker 实际是在`iptables`做了`DNAT`规则，实现端口转发功能。可以使用`iptables -t nat -vnL`查看。`bridge`模式如下图所示：
![[Pasted image 20250224202048.png]]


> 外部流量进入 Docker 容器时，是**不会直接进网桥（docker0）**的，而是通过宿主机上的端口映射（DNAT）或路由转发“间接”进入网桥。

下面来详细讲解这个过程。

---

## 🔄 一、外部流量是如何进入网桥容器网络的？

### 情况一：通过 `-p` 映射端口（最常见）

```bash
docker run -d -p 8080:80 nginx
```

此时你在浏览器访问 `http://<宿主机IP>:8080`，发生了什么？

### 数据流路径：

```
[外部请求: 8080] 
   ↓
[宿主机: eth0 上接收] 
   ↓
[iptables nat 表 -> PREROUTING 链]
   ↓
[DNAT 到容器 IP:80，例如 172.17.0.2:80]
   ↓
[docker0 网桥 → veth → 容器 eth0]
```

简化成图：

```
[Client] --> [宿主机 eth0:8080]
            ↓ DNAT (iptables)
         [容器 172.17.0.2:80]
```

- 这个过程依赖于 **iptables 规则**，由 Docker 自动创建。
    
- 外部访问的实际上是宿主机端口，Docker 会将流量 **转发到容器的私有 IP**。
    

---

### 情况二：容器使用 Host 模式

```bash
docker run --network host nginx
```

这种情况下，容器不使用 docker0 网桥，而是直接共享宿主机的网络栈：

- 外部访问宿主机 80 端口，其实就是访问 nginx。
    
- 不走 docker0，不存在桥接和转发。
    

---

## 🔍 二、查看 DNAT 规则

```bash
sudo iptables -t nat -L -n
```

你可以看到像这样的转发规则：

```
Chain DOCKER (2 references)
DNAT       tcp  --  0.0.0.0/0  0.0.0.0/0  tcp dpt:8080 → 172.17.0.2:80
```

这说明了：外部访问 `宿主机:8080`，会被 NAT 到容器的私有 IP 和端口。

---

## 🧱 三、总结机制

|场景|流量是否经过网桥（docker0）|原因/路径|
|---|---|---|
|`-p` 映射端口|✅|宿主机转发到容器私有 IP，经 docker0/veth 进入容器|
|`--network host`|❌（直接进入）|容器与宿主机共享网络，无需转发|
|外部未映射端口，直接访问容器 IP|❌|容器私网 IP 不对外暴露，无法被外部直接访问|

---

## 🛠 四、让容器直接暴露给外部（更高级）

- 使用 `--network host`
    
- 用反向代理（如 Nginx、Traefik）
    
- 或者配置 Linux 路由，让外部能访问容器私网（不推荐，复杂且易出错）
    

---

如果你想我画一张完整的图示来表示这个转发过程，我可以生成给你。你是否想要这张图？
# Host 模式
如果启动容器的时候使用`host`模式，那么这个容器将不会获得一个独立的`Network Namespace`，而是和宿主机共用一个 Network Namespace。容器将不会虚拟出自己的网卡，配置自己的 IP 等，而是使用宿主机的 IP 和端口。但是，容器的其他方面，如文件系统、进程列表等还是和宿主机隔离的。 Host模式如下图所示：
![[Pasted image 20250224204638.png]]

# Container 模式
这个模式指定新创建的容器和已经存在的一个容器共享一个 Network Namespace，而不是和宿主机共享。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过 lo 网卡设备通信。 Container模式示意图：
![[Pasted image 20250224204740.png]]
