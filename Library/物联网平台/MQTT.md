MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的"轻量级"通讯协议，该协议构建于TCP/IP协议上，由IBM在1999年发布。MQTT最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。

MQTT是一个基于客户端-服务器的消息发布/订阅传输协议。MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用。

### MQTT 的主要特点：

1. **轻量级**：协议的开销小，非常适合带宽有限的环境。
2. **发布/订阅模式**：客户端可以订阅特定主题，当有新的消息发布到该主题时，订阅者会收到消息。这使得系统的解耦性更强。
3. **质量服务（QoS）**：
    - **QoS 0**：最多一次发送，不保证送达。
    - **QoS 1**：至少一次发送，保证消息送达。
    - **QoS 2**：只有一次发送，保证消息只会送达一次。
4. **保持连接（Keep Alive）**：通过心跳机制保持客户端和服务器之间的连接。
5. **持久会话**：可以保存客户端的订阅和未送达的消息，适用于客户端断开后再重新连接的场景。
6. **低功耗**：适合嵌入式设备和电池驱动的设备，减少了网络传输的频率。

### MQTT 的应用场景：

- **物联网（IoT）**：设备之间的通信，尤其是资源受限的设备（如传感器、智能家居设备等）。
- **远程监控**：用于实时传输传感器数据、环境监测等。
- **即时消息推送**：适用于需要实时推送通知的应用（如消息应用、股票价格推送等）。

总之，MQTT 提供了一个高效、可靠的通信机制，尤其适合在带宽受限或者不稳定的网络环境中使用。

# 主要特性
MQTT协议工作在低带宽、不可靠的网络的远程传感器和控制设备通讯而设计的协议，它具有以下主要的几项特性：
- 使用发布/订阅消息模式，提高一对多的消息分布，解除应用程序耦合
- 对负载内容屏蔽的消息传输
- 使用 TCP/IP 提供网络连接：主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。
- 有三种消息发布服务质量：
	- "至多一次"，消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。这一种方式主要普通APP的推送，倘若你的智能设备在消息推送时未联网，推送过去没收到，再次联网也就收不到了。
	- "至少一次"，确保消息到达，但消息重复可能会发生。
	- "只有一次"，确保消息到达一次。在一些要求比较严格的计费系统中，可以使用此级别。在计费系统中，消息重复或丢失会导致不正确的结果。这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。
- 小型传输，开销很小（固定长度的头部是2字节），协议交换最小化，以降低网络流量。

# 协议原理
## 4.1 MQTT 协议实现方式
实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

MQTT传输的消息分为：主题（Topic）和负载（payload）两部分：
- Topic，可以理解为消息的类型，订阅者订阅后，就会收到该主题的消息内容（payload）；
- payload，可以理解为消息的内容。

## 4.2 网络传输与应用消息
MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。当应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

## 4.3 MQTT 客户端
一个使用 MQTT 协议的应用程序或者设备，它总是建立到服务器的网络连接。客户端可以：
- 发布其他客户端可能会订阅的信息；
- 订阅其他客户端发布的消息；
- 退订或删除应用程序的消息；
- 断开与服务器连接

## 4.4 MQTT 服务器
MQTT 服务器称为“消息代理”（Broker），可以是一个应用程序或一台设备。它位于消息发布者和订阅者之间，它可以：
- 接受来自客户的网络连接；
- 接受客户发布的应用信息；
- 处理来自客户端的订阅和退订请求；
- 向订阅的客户转发应用程序消息。

## 4.5 MQTT 协议中的订阅、主题、会话
MQTT 协议中定义了一些方法（也被称为动作），用来表示对确定资源所进行操作。这个资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现。通常来说，资源指服务器上的文件或输出。主要方法有：
- Connect。等待与服务器建立连接
- Disconnect。等待 MQTT 客户端完成所做的工作，并与服务器断开 TCP/IP 会话
- Subscribe。等待完成订阅
- UnSubscribe。等待服务器取消客户端的一个或多个 topics 订阅。
- Publish。 MQTT 客户端发送消息请求，发送完成后返回应用程序线程。

